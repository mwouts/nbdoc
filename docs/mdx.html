---

title: Custom Preprocessors For MDX


keywords: fastai
sidebar: home_sidebar

summary: "Custom preprocessors that help convert notebook content into MDX"
description: "Custom preprocessors that help convert notebook content into MDX"
nb_path: "nbs/mdx.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/mdx.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="vm">__file__</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s2">&quot;lib_path&quot;</span><span class="p">)</span><span class="o">/</span><span class="s1">&#39;preproc.py&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">run_preprocessor</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">nbfile</span><span class="p">,</span> <span class="n">template_file</span><span class="o">=</span><span class="s1">&#39;ob.tpl&#39;</span><span class="p">,</span> <span class="n">display_results</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">MarkdownExporter</span><span class="o">.</span><span class="n">preprocessors</span> <span class="o">=</span> <span class="n">pp</span>
    <span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">/</span><span class="s1">&#39;templates/&#39;</span>
    <span class="n">tmp_file</span> <span class="o">=</span> <span class="n">tmp_dir</span><span class="o">/</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">template_file</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">c</span><span class="o">.</span><span class="n">MarkdownExporter</span><span class="o">.</span><span class="n">template_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">)</span>
    <span class="n">exp</span> <span class="o">=</span>  <span class="n">MarkdownExporter</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">from_filename</span><span class="p">(</span><span class="n">nbfile</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">display_results</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">show_plain_md</span><span class="p">(</span><span class="n">nbfile</span><span class="p">):</span>
    <span class="n">md</span> <span class="o">=</span> <span class="n">MarkdownExporter</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">md</span><span class="o">.</span><span class="n">from_filename</span><span class="p">(</span><span class="n">nbfile</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="CleanOutput" class="doc_header"><code>class</code> <code>CleanOutput</code><a href="https://github.com/outerbounds/nbdoc/tree/master/nbdoc/mdx.py#L17" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>CleanOutput</code>(<strong>*<code>args</code></strong>, <strong>**<code>kwargs</code></strong>) :: <code>Preprocessor</code></p>
</blockquote>
<p>Remove the preamble from Metaflow output.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="WriteTitle" class="doc_header"><code>class</code> <code>WriteTitle</code><a href="https://github.com/outerbounds/nbdoc/tree/master/nbdoc/mdx.py#L30" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>WriteTitle</code>(<strong>*<code>args</code></strong>, <strong>**<code>kwargs</code></strong>) :: <code>Preprocessor</code></p>
</blockquote>
<p>Modify the code-fence with the filename upon %%writefile cell magic.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="/nbdoc/mdx.html#WriteTitle"><code>WriteTitle</code></a> creates the proper code-fence with a title in the situation where the <code>%%writefile</code> magic is used.</p>
<p>For example, here are contents before pre-processing:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">show_plain_md</span><span class="p">(</span><span class="s1">&#39;test_files/writefile.ipynb&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>A test notebook


```python
%%writefile myflow.py

from metaflow import FlowSpec, step

class MyFlow(FlowSpec):
    
    @step
    def start(self):
        print(&#39;this is the start&#39;)
        self.next(self.end)
    
    @step
    def end(self):
        print(&#39;this is the end&#39;)

if __name__ == &#39;__main__&#39;:
    MyFlow()
```

    Overwriting myflow.py



```python
%%writefile hello.txt

Hello World
```

    Overwriting hello.txt


</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>When we use <a href="/nbdoc/mdx.html#WriteTitle"><code>WriteTitle</code></a>, you will see the code-fence will change appropriately:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">c</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">run_preprocessor</span><span class="p">([</span><span class="n">WriteTitle</span><span class="p">],</span> <span class="s1">&#39;test_files/writefile.ipynb&#39;</span><span class="p">,</span> <span class="n">display_results</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;```py title=&quot;myflow.py&quot;&#39;</span>
<span class="k">assert</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">24</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;```txt title=&quot;hello.txt&quot;&#39;</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>A test notebook


```py title=&#34;myflow.py&#34;
%%writefile myflow.py

from metaflow import FlowSpec, step

class MyFlow(FlowSpec):
    
    @step
    def start(self):
        print(&#39;this is the start&#39;)
        self.next(self.end)
    
    @step
    def end(self):
        print(&#39;this is the end&#39;)

if __name__ == &#39;__main__&#39;:
    MyFlow()
```


```txt title=&#34;hello.txt&#34;
%%writefile hello.txt

Hello World
```

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="CleanMagics" class="doc_header"><code>class</code> <code>CleanMagics</code><a href="https://github.com/outerbounds/nbdoc/tree/master/nbdoc/mdx.py#L44" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>CleanMagics</code>(<strong>*<code>args</code></strong>, <strong>**<code>kwargs</code></strong>) :: <code>Preprocessor</code></p>
</blockquote>
<p>A preprocessor to remove cell magic commands</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="BashIdentify" class="doc_header"><code>class</code> <code>BashIdentify</code><a href="https://github.com/outerbounds/nbdoc/tree/master/nbdoc/mdx.py#L54" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>BashIdentify</code>(<strong>*<code>args</code></strong>, <strong>**<code>kwargs</code></strong>) :: <code>Preprocessor</code></p>
</blockquote>
<p>A preprocessor to identify bash commands and mark them appropriately</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_exporter" class="doc_header"><code>get_exporter</code><a href="https://github.com/outerbounds/nbdoc/tree/master/nbdoc/mdx.py#L65" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_exporter</code>(<strong><code>template_file</code></strong>=<em><code>'ob.tpl'</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">hamel</span> <span class="o">=</span> <span class="n">get_exporter</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">show_plain_md</span><span class="p">(</span><span class="s1">&#39;test_files/example_input.ipynb&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>---
title: my hello page title
description: my hello page description
hide_table_of_contents: true
---

```python
! echo hello
```

    hello



```python
%%writefile myflow.py

from metaflow import FlowSpec, step

class MyFlow(FlowSpec):
    
    @step
    def start(self):
        print(&#39;this is the start&#39;)
        self.next(self.end)
    
    @step
    def end(self):
        print(&#39;this is the end&#39;)

if __name__ == &#39;__main__&#39;:
    MyFlow()
```

    Overwriting myflow.py



```python
! python myflow.py run
```

    <span class="ansi-magenta-intense-fg ansi-bold">Metaflow 2.5.0.post6+git62f5e52</span><span class="ansi-magenta-fg"> executing </span><span class="ansi-red-intense-fg ansi-bold">MyFlow</span><span class="ansi-magenta-fg"> for </span><span class="ansi-red-intense-fg ansi-bold">user:hamel</span>
    <span class="ansi-magenta-fg">Validating your flow...</span>
    <span class="ansi-green-intense-fg ansi-bold">    The graph looks good!</span>
    <span class="ansi-magenta-fg">Running pylint...</span>
    <span class="ansi-green-intense-fg ansi-bold">    Pylint is happy!</span>
    <span class="ansi-magenta-fg">2022-02-14 10:39:55.240 </span><span class="ansi-bold">Workflow starting (run-id 1644863995236850):</span>
    <span class="ansi-magenta-fg">2022-02-14 10:39:55.247 </span><span class="ansi-green-fg">[1644863995236850/start/1 (pid 97470)] </span><span class="ansi-bold">Task is starting.</span>
    <span class="ansi-magenta-fg">2022-02-14 10:39:55.840 </span><span class="ansi-green-fg">[1644863995236850/start/1 (pid 97470)] </span>this is the start
    <span class="ansi-magenta-fg">2022-02-14 10:39:55.911 </span><span class="ansi-green-fg">[1644863995236850/start/1 (pid 97470)] </span><span class="ansi-bold">Task finished successfully.</span>
    <span class="ansi-magenta-fg">2022-02-14 10:39:55.919 </span><span class="ansi-green-fg">[1644863995236850/end/2 (pid 97476)] </span><span class="ansi-bold">Task is starting.</span>
    <span class="ansi-magenta-fg">2022-02-14 10:39:56.519 </span><span class="ansi-green-fg">[1644863995236850/end/2 (pid 97476)] </span>this is the end
    <span class="ansi-magenta-fg">2022-02-14 10:39:56.593 </span><span class="ansi-green-fg">[1644863995236850/end/2 (pid 97476)] </span><span class="ansi-bold">Task finished successfully.</span>
    <span class="ansi-magenta-fg">2022-02-14 10:39:56.593 </span><span class="ansi-bold">Done!</span>
    


```python
a = 2
a
```




    2



</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">hamel</span><span class="o">.</span><span class="n">from_filename</span><span class="p">(</span><span class="s1">&#39;test_files/example_input.ipynb&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>---
title: my hello page title
description: my hello page description
hide_table_of_contents: true
---

```bash
echo hello
```

    hello



```py title=&#34;myflow.py&#34;
from metaflow import FlowSpec, step

class MyFlow(FlowSpec):
    
    @step
    def start(self):
        print(&#39;this is the start&#39;)
        self.next(self.end)
    
    @step
    def end(self):
        print(&#39;this is the end&#39;)

if __name__ == &#39;__main__&#39;:
    MyFlow()
```


```bash
python myflow.py run
```

    2022-02-14 10:39:55.240 Workflow starting (run-id 1644863995236850):
    2022-02-14 10:39:55.247 [1644863995236850/start/1 (pid 97470)] Task is starting.
    2022-02-14 10:39:55.840 [1644863995236850/start/1 (pid 97470)] this is the start
    2022-02-14 10:39:55.911 [1644863995236850/start/1 (pid 97470)] Task finished successfully.
    2022-02-14 10:39:55.919 [1644863995236850/end/2 (pid 97476)] Task is starting.
    2022-02-14 10:39:56.519 [1644863995236850/end/2 (pid 97476)] this is the end
    2022-02-14 10:39:56.593 [1644863995236850/end/2 (pid 97476)] Task finished successfully.
    2022-02-14 10:39:56.593 Done!


```python
a = 2
a
```




    2



</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

